name: Lab 5 - Accessibility Audit CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  grading-checks:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check required files exist
        id: files
        run: |
          echo "## üìÅ File Check" >> $GITHUB_STEP_SUMMARY

          MISSING_FILES=""
          REQUIRED_FILES=(
            "src/components/EventCard.tsx"
            "src/components/EventFilter.tsx"
            "src/components/RegistrationForm.tsx"
            "src/components/EventsPage.tsx"
            "src/data/events.ts"
            "src/__tests__/EventCard.test.tsx"
            "src/__tests__/EventFilter.test.tsx"
            "src/__tests__/RegistrationForm.test.tsx"
            "src/__tests__/EventsPage.test.tsx"
            "src/AUDIT_REPORT.md"
            "src/setupTests.ts"
            "vitest.config.ts"
            "tsconfig.json"
            "README.md"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå $file (MISSING)" >> $GITHUB_STEP_SUMMARY
              MISSING_FILES="$MISSING_FILES $file"
            fi
          done

          if [ -n "$MISSING_FILES" ]; then
            echo "files_missing=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Some required files are missing!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "files_missing=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All required files present!**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check test count
        id: test_count
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ Test Count" >> $GITHUB_STEP_SUMMARY

          # Run vitest with json reporter
          npm run test:run -- --reporter=json --outputFile=test-results.json 2>/dev/null || true

          if [ -f test-results.json ]; then
            TOTAL_TESTS=$(cat test-results.json | grep -o '"numTotalTests":[0-9]*' | grep -o '[0-9]*' || echo "0")
            PASSED_TESTS=$(cat test-results.json | grep -o '"numPassedTests":[0-9]*' | grep -o '[0-9]*' || echo "0")
          else
            TOTAL_TESTS=$(npm run test:run 2>&1 | grep -oP '\d+(?= tests?)' | tail -1 || echo "0")
            PASSED_TESTS=$TOTAL_TESTS
          fi

          echo "Total tests found: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "Passed tests: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY

          MIN_TESTS=20

          if [ "$TOTAL_TESTS" -ge "$MIN_TESTS" ]; then
            echo "‚úÖ **Test count meets minimum ($TOTAL_TESTS >= $MIN_TESTS)**" >> $GITHUB_STEP_SUMMARY
            echo "test_count_met=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå **Test count below minimum ($TOTAL_TESTS < $MIN_TESTS)**" >> $GITHUB_STEP_SUMMARY
            echo "test_count_met=false" >> $GITHUB_OUTPUT
          fi

      - name: Check coverage threshold
        id: coverage
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Code Coverage" >> $GITHUB_STEP_SUMMARY

          npm run test:coverage 2>&1 | tee coverage-output.txt || true

          STATEMENTS=$(grep -oP 'Statements\s*:\s*\K[\d.]+' coverage-output.txt || echo "0")
          BRANCHES=$(grep -oP 'Branches\s*:\s*\K[\d.]+' coverage-output.txt || echo "0")
          FUNCTIONS=$(grep -oP 'Functions\s*:\s*\K[\d.]+' coverage-output.txt || echo "0")
          LINES=$(grep -oP 'Lines\s*:\s*\K[\d.]+' coverage-output.txt || echo "0")

          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY

          THRESHOLD=90

          BELOW_THRESHOLD=false
          for coverage in $STATEMENTS $BRANCHES $FUNCTIONS $LINES; do
            if [ $(echo "$coverage < $THRESHOLD" | bc -l) -eq 1 ]; then
              BELOW_THRESHOLD=true
            fi
          done

          if [ "$BELOW_THRESHOLD" = "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All coverage metrics meet ${THRESHOLD}% threshold**" >> $GITHUB_STEP_SUMMARY
            echo "coverage_met=true" >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Some coverage metrics below ${THRESHOLD}% threshold**" >> $GITHUB_STEP_SUMMARY
            echo "coverage_met=false" >> $GITHUB_OUTPUT
          fi

      - name: Check audit report
        id: audit
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Audit Report Check" >> $GITHUB_STEP_SUMMARY

          AUDIT_OK=true

          if [ -f "src/AUDIT_REPORT.md" ]; then
            echo "‚úÖ Audit report file exists" >> $GITHUB_STEP_SUMMARY

            # Count findings (look for "### Finding" headers)
            FINDING_COUNT=$(grep -c "^### Finding" src/AUDIT_REPORT.md || echo "0")
            echo "Findings documented: $FINDING_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ "$FINDING_COUNT" -ge 12 ]; then
              echo "‚úÖ **Meets minimum of 12 findings ($FINDING_COUNT found)**" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è **Below minimum of 12 findings ($FINDING_COUNT found)**" >> $GITHUB_STEP_SUMMARY
              AUDIT_OK=false
            fi

            # Check for POUR references
            if grep -qi "perceivable\|operable\|understandable\|robust" src/AUDIT_REPORT.md; then
              echo "‚úÖ POUR principles referenced" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è POUR principles not explicitly referenced" >> $GITHUB_STEP_SUMMARY
              AUDIT_OK=false
            fi

            # Check for WCAG criterion references
            if grep -qiE "wcag|[0-9]\.[0-9]+\.[0-9]+" src/AUDIT_REPORT.md; then
              echo "‚úÖ WCAG criteria referenced" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è WCAG criteria not referenced" >> $GITHUB_STEP_SUMMARY
              AUDIT_OK=false
            fi
          else
            echo "‚ùå Audit report file missing" >> $GITHUB_STEP_SUMMARY
            AUDIT_OK=false
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$AUDIT_OK" = "true" ]; then
            echo "audit_ok=true" >> $GITHUB_OUTPUT
          else
            echo "audit_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Check README content
        id: readme
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìù README Check" >> $GITHUB_STEP_SUMMARY

          README_ISSUES=""

          if grep -qi "reflection" README.md; then
            echo "‚úÖ Reflection section found" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing reflection section" >> $GITHUB_STEP_SUMMARY
            README_ISSUES="$README_ISSUES reflection"
          fi

          if grep -qi "key concepts\|concepts learned\|what i learned" README.md; then
            echo "‚úÖ Key concepts section found" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing key concepts section" >> $GITHUB_STEP_SUMMARY
            README_ISSUES="$README_ISSUES concepts"
          fi

          WORD_COUNT=$(wc -w < README.md)
          if [ "$WORD_COUNT" -ge 200 ]; then
            echo "‚úÖ README has sufficient content ($WORD_COUNT words)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è README may be too short ($WORD_COUNT words, aim for 200+)" >> $GITHUB_STEP_SUMMARY
            README_ISSUES="$README_ISSUES length"
          fi

          if grep -qi "name:\|author:\|by:" README.md; then
            echo "‚úÖ Student name appears to be present" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Student name may be missing" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "$README_ISSUES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **README meets requirements**" >> $GITHUB_STEP_SUMMARY
            echo "readme_complete=true" >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **README may need improvement**" >> $GITHUB_STEP_SUMMARY
            echo "readme_complete=false" >> $GITHUB_OUTPUT
          fi

      - name: Check accessibility fixes in components
        id: a11y_fixes
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ôø Accessibility Fix Checks" >> $GITHUB_STEP_SUMMARY

          A11Y_OK=true

          # EventCard checks
          echo "### EventCard" >> $GITHUB_STEP_SUMMARY
          if grep -q 'alt=' src/components/EventCard.tsx; then
            echo "‚úÖ Image has alt attribute" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Image missing alt attribute" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          if grep -qE '<h[2-6]' src/components/EventCard.tsx; then
            echo "‚úÖ Uses heading element for title" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Still using <b> instead of heading for title" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          if grep -q '<button' src/components/EventCard.tsx; then
            echo "‚úÖ Uses <button> element for register" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Still using <div> instead of <button> for register" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          # EventFilter checks
          echo "### EventFilter" >> $GITHUB_STEP_SUMMARY
          if grep -q '<button' src/components/EventFilter.tsx; then
            echo "‚úÖ Uses <button> elements for filters" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Still using <div> instead of <button> for filters" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          if grep -q 'aria-pressed' src/components/EventFilter.tsx; then
            echo "‚úÖ Uses aria-pressed for selected state" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing aria-pressed for selected state" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          # RegistrationForm checks
          echo "### RegistrationForm" >> $GITHUB_STEP_SUMMARY
          if grep -q '<label' src/components/RegistrationForm.tsx; then
            echo "‚úÖ Uses <label> elements" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing <label> elements" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          if grep -q '<form' src/components/RegistrationForm.tsx; then
            echo "‚úÖ Uses <form> element" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing <form> element" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          if grep -q 'role="dialog"\|role=.dialog.' src/components/RegistrationForm.tsx; then
            echo "‚úÖ Dialog has role='dialog'" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing role='dialog'" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          # EventsPage checks
          echo "### EventsPage" >> $GITHUB_STEP_SUMMARY
          if grep -q '<main' src/components/EventsPage.tsx; then
            echo "‚úÖ Uses <main> landmark" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing <main> landmark" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          if grep -q '<h1' src/components/EventsPage.tsx; then
            echo "‚úÖ Uses <h1> for page title" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Missing <h1> for page title" >> $GITHUB_STEP_SUMMARY
            A11Y_OK=false
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$A11Y_OK" = "true" ]; then
            echo "‚úÖ **All checked accessibility fixes present**" >> $GITHUB_STEP_SUMMARY
            echo "a11y_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è **Some accessibility fixes still needed**" >> $GITHUB_STEP_SUMMARY
            echo "a11y_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate grading summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Grading Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Criteria | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.files.outputs.files_missing }}" = "false" ]; then
            echo "| Required Files | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Required Files | ‚ùå Missing files |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.test_count.outputs.test_count_met }}" = "true" ]; then
            echo "| Minimum Tests (20) | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Minimum Tests (20) | ‚ùå Below minimum |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.coverage.outputs.coverage_met }}" = "true" ]; then
            echo "| Coverage (90%) | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Coverage (90%) | ‚ö†Ô∏è Below threshold |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.audit.outputs.audit_ok }}" = "true" ]; then
            echo "| Audit Report (12+ findings) | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Audit Report (12+ findings) | ‚ö†Ô∏è Needs review |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.a11y_fixes.outputs.a11y_ok }}" = "true" ]; then
            echo "| Accessibility Fixes | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Accessibility Fixes | ‚ö†Ô∏è Incomplete |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.readme.outputs.readme_complete }}" = "true" ]; then
            echo "| README Complete | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| README Complete | ‚ö†Ô∏è Needs review |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Note: This is an automated check. Manual review of audit report quality, fix completeness, and reflection depth will also be performed.*" >> $GITHUB_STEP_SUMMARY
